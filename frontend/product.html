<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Television Store</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">üì∫ TV Store</a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="catalog.html">Catalog</a></li>
                <li><a href="cart.html">Cart (<span id="cart-count">0</span>)</a></li>
                <li class="nav-user">
                    <span class="user-name" id="user-name"></span>
                    <a href="dashboard.html" id="dashboard-link" style="display: none;">Dashboard</a>
                    <a href="admin.html" id="admin-link" style="display: none;">Admin</a>
                    <a href="login.html" id="login-link">Login</a>
                    <button class="btn btn-sm btn-danger" id="logout-btn" style="display: none;">Logout</button>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div id="loading" class="loading">Loading product...</div>

        <div id="product-details" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
                <div>
                                        <img
                                        
                    class="cart-item-img"
                    src="images/tv-default.png"
                    alt="TV Image">
                </div>

                <div>
                    <h1 id="product-title" class="page-title"></h1>
                    <div id="product-price" class="product-price" style="margin: 1rem 0;"></div>
                    <p id="product-stock" class="product-stock"></p>

                    <div style="margin: 2rem 0;">
                        <h3 style="margin-bottom: 1rem;">Specifications</h3>
                        <div id="product-specs" style="background: var(--bg-light); padding: 1.5rem; border-radius: 0.5rem;"></div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <div class="form-group" style="width: 100px;">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="quantity" value="1" min="1">
                        </div>
                        <div style="flex: 1; display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" id="add-to-cart-btn" style="width: 100%;">Add to Cart</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 class="page-title">Customer Reviews</h2>
                    <button class="btn btn-primary" id="add-review-btn">Write a Review</button>
                </div>

                <div id="reviews-list"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="review-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Write a Review</h2>
            </div>
            <form id="review-form">
                <div class="form-group">
                    <label class="form-label">Rating</label>
                    <select class="form-select" id="review-rating" required>
                        <option value="">Select rating...</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 stars)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 stars)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3 stars)</option>
                        <option value="2">‚≠ê‚≠ê (2 stars)</option>
                        <option value="1">‚≠ê (1 star)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Comment</label>
                    <textarea class="form-textarea" id="review-comment" required minlength="5"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancel-review">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentProduct = null;
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        function updateNavigation() {
            const user = getCurrentUser();
            const loginLink = document.getElementById('login-link');
            const logoutBtn = document.getElementById('logout-btn');
            const userName = document.getElementById('user-name');
            const dashboardLink = document.getElementById('dashboard-link');
            const adminLink = document.getElementById('admin-link');
            
            if (user) {
                loginLink.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userName.textContent = user.name;
                dashboardLink.style.display = 'inline-block';
                
                if (user.role === 'admin') {
                    adminLink.style.display = 'inline-block';
                }
            }
            
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            document.getElementById('cart-count').textContent = cart.length;
        }

        document.getElementById('logout-btn')?.addEventListener('click', logout);

        async function loadProduct() {
            try {
                const product = await API.getTVById(productId);
                currentProduct = product;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('product-details').style.display = 'block';

                document.getElementById('product-title').textContent = `${product.brand} ${product.model}`;
                document.getElementById('product-price').textContent = formatPrice(product.price);
                
                const stockEl = document.getElementById('product-stock');
                stockEl.textContent = product.stock > 0 ? `${product.stock} in stock` : 'Out of stock';
                stockEl.className = `product-stock ${product.stock > 0 ? 'in-stock' : 'out-of-stock'}`;

                const specsHTML = `
                    <p><strong>Size:</strong> ${product.specs?.size || 'N/A'}</p>
                    <p><strong>Resolution:</strong> ${product.specs?.resolution || 'N/A'}</p>
                    <p><strong>Smart TV:</strong> ${product.specs?.smartTV ? 'Yes' : 'No'}</p>
                    <p><strong>HDMI Ports:</strong> ${product.specs?.hdmiPorts || 'N/A'}</p>
                `;
                document.getElementById('product-specs').innerHTML = specsHTML;

                document.getElementById('quantity').max = product.stock;

                if (product.stock === 0) {
                    document.getElementById('add-to-cart-btn').disabled = true;
                    document.getElementById('add-to-cart-btn').textContent = 'Out of Stock';
                }

                displayReviews(product.reviews || []);
            } catch (error) {
                console.error('Error loading product:', error);
                document.getElementById('loading').textContent = 'Error loading product';
            }
        }

        function displayReviews(reviews) {
            const container = document.getElementById('reviews-list');

            if (reviews.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No reviews yet. Be the first to review!</p></div>';
                return;
            }

            container.innerHTML = reviews.map(review => {
                const stars = '‚≠ê'.repeat(review.rating);
                const user = getCurrentUser();
                const canDelete = user && (user.id === review.userId?._id || user.role === 'admin');

                return `
                    <div class="review">
                        <div class="review-header">
                            <div>
                                <span class="review-author">${review.userId?.name || 'Anonymous'}</span>
                                <span class="review-rating"> ${stars}</span>
                            </div>
                            ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="deleteReview('${review._id}')">Delete</button>` : ''}
                        </div>
                        <p class="review-comment">${review.comment}</p>
                        <small style="color: var(--text-light);">${formatDate(review.createdAt || new Date())}</small>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('add-to-cart-btn').addEventListener('click', () => {
            const quantity = parseInt(document.getElementById('quantity').value);
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            const existing = cart.find(item => item.tvId === productId);
            if (existing) {
                existing.quantity += quantity;
            } else {
                cart.push({ tvId: productId, quantity });
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            updateNavigation();
            showNotification(`Added ${quantity} item(s) to cart!`, 'success');
        });

        const reviewModal = document.getElementById('review-modal');
        const addReviewBtn = document.getElementById('add-review-btn');
        const cancelReviewBtn = document.getElementById('cancel-review');

        addReviewBtn.addEventListener('click', () => {
            if (!isLoggedIn()) {
                showNotification('Please login to write a review', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }
            reviewModal.classList.add('active');
        });

        cancelReviewBtn.addEventListener('click', () => {
            reviewModal.classList.remove('active');
        });

        reviewModal.addEventListener('click', (e) => {
            if (e.target === reviewModal) {
                reviewModal.classList.remove('active');
            }
        });

        document.getElementById('review-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rating = parseInt(document.getElementById('review-rating').value);
            const comment = document.getElementById('review-comment').value;

            try {
                const result = await API.addReview(productId, rating, comment);
                
                showNotification('Review added successfully!', 'success');
                reviewModal.classList.remove('active');
                document.getElementById('review-form').reset();
                
                loadProduct();
            } catch (error) {
                showNotification('Failed to add review', 'error');
            }
        });

        async function deleteReview(reviewId) {
            if (!confirm('Are you sure you want to delete this review?')) return;

            try {
                await API.deleteReview(productId, reviewId);
                showNotification('Review deleted', 'success');
                loadProduct();
            } catch (error) {
                showNotification('Failed to delete review', 'error');
            }
        }

        if (!productId) {
            window.location.href = 'catalog.html';
        } else {
            updateNavigation();
            loadProduct();
        }
    </script>
</body>
</html>